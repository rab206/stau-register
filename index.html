<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>St Albans Training Register</title>
  <link rel="stylesheet" href="//unpkg.com/tachyons@4.6.1/css/tachyons.min.css" />
  <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
  <style type='text/css'>
    body {
      background: #FFF;
    }
    
    nav {
      background-color: #afbfbf;
    }
    
    body {
      font-family: Roboto, Arial, sans-serif;
    }
  </style>
</head>

<body>
  <nav class="dt w-100 pa2 ph5-ns">
    <div class="dtc v-mid mid-gray dim tr">
      <img class="dib h2" src="//stalbansultimate.co.uk/img/eagle_logo_s.png">
    </div>
    <div class="dtc v-mid w-85 pl2">
      <h1 class="white normal f4 dib ma2 mr4-ns">St Albans Training Register</h1>
    </div>
  </nav>
  <div class="fl w-100 mv3">
    <form id="form" class="pa4 black-80">
      <div class="dt w-100 mt1">
        <div class="name dtc mh1">
          <div class="mh1">
            <label for="name" class="f6 b db mb2">Your Name <span class="normal black-60">(mandatory)</span></label>
            <input id="name" list="peopleList" required class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="name-desc">
            <small id="name-desc" class="f6 black-60 db mb2">Name of the person taking the register.</small>
          </div>
        </div>
        <div class="date dtc mh1">
          <div class="mh1">
            <label for="date" class="f6 b db mb2">Session Date <span class="normal black-60">(mandatory)</span></label>
            <input id="date" required class="input-reset ba b--black-20 pa2 mb2 db w-100" type="date" aria-describedby="date-desc">
            <small id="date-desc" class="f6 black-60 db mb2">The date of the session.</small>
          </div>
        </div>
      </div>
      <div class="comment">
        <label for="comment" class="f6 b db mb2">Comment for treasurer <span class="normal black-60">(optional)</span></label>
        <input id="comment" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="comment-desc">
        <small id="comment-desc" class="f6 black-60 db mb2">E.g. trials or small pitch only</small>
      </div>
      <div class="people">
        <label for="people" class="f6 b db mb2">People</label>
        <div class="dt">
          <div class="dtc">
            <input id="people" list="peopleList" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="people-desc" placeholder="loading people...">
          </div>
          <div class="dtc">
            <div class="mt3"><input id="addPerson" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="button" value="Add"></div>
          </div>
        </div>
        <small id="people-desc" class="f6 black-60 db mb2">Search for people (or write their full name if they are not found) and then click add</small>
        <datalist id="peopleList"></datalist>

        <div class="pa0 pv2">
          <div class="overflow-auto">
            <table class="f6 w-100 mw8 center" cellspacing="0">
              <thead>
                <tr class="stripe-dark">
                  <th class="fw6 tl pa3 bg-white">Name</th>
                  <th class="fw6 tl pa3 bg-white">Balance</th>
                  <th class="fw6 tl pa3 bg-white"></th>
                </tr>
              </thead>
              <tbody id="addedPeople" class="lh-copy">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mt3"><input id="submit" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="submit" value="Submit"></div>
    </form>
  </div>
  <script type='text/javascript'>
    /* global */
    window.onload = function() {
      document.getElementById('date').valueAsDate = new Date();

      var tempscript = document.createElement("script");
      tempscript.type = "text/javascript";
      tempscript.id = "tempscript";
      tempscript.src = "https://spreadsheets.google.com/feeds/list/1j9z1tQwSwxclM-ucThVbraR_JaQcvnwnPoDGFLGUFfU/1/public/values?alt=json-in-script&callback=onComplete";
      document.body.appendChild(tempscript);
    };

    var people, peopleMap;
    var peopleList = [];
    var peopleField = document.getElementById('people');
    var dataList = document.getElementById('peopleList');
    var addedPeople = document.getElementById('addedPeople');

    function onComplete(data) {
      console.log(data);
      people = data.feed.entry;
      var options = "";
      peopleMap = {};
      people.sort(function compare(a, b) {
        var nameA = a.gsx$name.$t.toUpperCase(); // ignore upper and lowercase
        var nameB = b.gsx$name.$t.toUpperCase(); // ignore upper and lowercase
        if (nameA < nameB) {
          return -1;
        }
        if (nameA > nameB) {
          return 1;
        }
        // names must be equal
        return 0;
      });
      people.map(p => {
        var name = p.gsx$name.$t;
        options += `<option value="${name}">`;
        peopleMap[name] = {
          name,
          balance: p.gsx$balance2017.$t
        };
      });
      dataList.innerHTML = options;
      peopleField.placeholder = "type name...";
    }

    document.getElementById('addPerson').onclick = () => {
      var name = peopleField.value;
      if (!peopleList.includes(name)) {
        var balance = "Unknown user";
        var rowClass = "";
        if (peopleMap[name]) {
          balance = peopleMap[name].balance;
          if (balance < 0) {
            rowClass = "red";
          }
          balance = "Â£" + balance;
        }
        addedPeople.insertAdjacentHTML("beforeend",
          `<tr class="stripe-dark ${rowClass}">
          <td class="pa3">${name}</td>
          <td class="pa3">${balance}</td>
          <td class="pa3"><input onClick="removePerson(this, '${name}')" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="button" value="Remove"></td>
        </tr>`);
        peopleList.push(name);
      }
      peopleField.value = "";
    };

    function removePerson(element, name) {
      console.log(element, name);
      element.parentElement.parentElement.remove()
      peopleList.splice(peopleList.indexOf(name), 1);

    }
    
    function generatePeopleList() {
      return peopleList.join('\r\n');
    }
    
    document.getElementById('form').addEventListener("submit", (e) => {
      e.preventDefault();
      var email = 'treasurer@stalbansultimate.co.uk';
      var date = document.getElementById('date').value;
      var name = document.getElementById('name').value;
      var comment = document.getElementById('comment').value;
      var subject = `Register for  ${date}`;
      var emailBody = 
`Hi Treasurer,\r\n
Here is the register for ${date}.\r\n
\r\n
Comment: ${comment}\r\n
\r\n
Register;
${peopleList.join('\r\n')}\r\n
\r\n
Thanks,\r\n
${name}\r\n
`;
      window.location.href = "mailto:"+email+"?subject="+subject+"&body="+encodeURIComponent(emailBody);
    });
  </script>
  <script id="__bs_script__">
    //<![CDATA[
    document.write("<script async src='https://HOST:8082/browser-sync/browser-sync-client.js?v=2.18.8'><\/script>".replace("HOST", location.hostname));
    //]]>
  </script>
</body>

</html>
