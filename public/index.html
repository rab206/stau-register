<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>St Albans Training Register</title>
  <link rel="stylesheet" href="//unpkg.com/tachyons@4.6.1/css/tachyons.min.css" />
  <link rel="manifest" href="/manifest.json">
  <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
  <style type='text/css'>
    body {
      background: #FFF;
      font-family: Roboto, Arial, sans-serif;
    }
    
    nav {
      background: #c0c0c0;
    }
  </style>
</head>

<body>
  <nav class="dt w-100 pa2 ph5-ns">
    <div class="dtc v-mid mid-gray dim tr">
      <img alt="St Albans Ultimate logo" class="dib h2" src="eagle_logo_s.png">
    </div>
    <div class="dtc v-mid w-85 pl2">
      <h1 class="white normal f4 dib ma2 mr4-ns">St Albans Training Register</h1>
    </div>
  </nav>
  <div class="fl w-100 mv3">
    <form id="form" class="pa4 black-80">
      <div class="dt w-100 mt1">
        <div class="name dtc mh1">
          <div class="mh1">
            <label for="name" class="f6 b db mb2">Your Name <span class="normal black-60">(mandatory)</span></label>
            <input id="name" list="peopleList" required class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="name-desc">
            <small id="name-desc" class="f6 black-60 db mb2">Name of the person taking the register.</small>
          </div>
        </div>
        <div class="date dtc mh1">
          <div class="mh1">
            <label for="date" class="f6 b db mb2">Session Date <span class="normal black-60">(mandatory)</span></label>
            <input id="date" required class="input-reset ba b--black-20 pa2 mb2 db w-100" type="date" aria-describedby="date-desc">
            <small id="date-desc" class="f6 black-60 db mb2">The date of the session.</small>
          </div>
        </div>
      </div>
      <div class="comment">
        <label for="comment" class="f6 b db mb2">Comment for treasurer <span class="normal black-60">(optional)</span></label>
        <input id="comment" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="comment-desc">
        <small id="comment-desc" class="f6 black-60 db mb2">E.g. trials or small pitch only</small>
      </div>
      <div class="people">
        <label for="people" class="f6 b db mb2">People</label>
        <div class="dt">
          <div class="dtc">
            <input id="people" list="peopleList" class="input-reset ba b--black-20 pa2 mb2 db w-100" type="text" aria-describedby="people-desc" placeholder="loading people...">
          </div>
          <div class="dtc">
            <div class="mt3"><input id="addPerson" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="button" value="Add"></div>
          </div>
        </div>
        <small id="people-desc" class="f6 black-60 db mb2">Search for people (or write their full name if they are new)</small>
        <datalist id="peopleList"></datalist>
        <p>Number of people: <span id="total">0</span></p>
        <div class="pa0 pv1">
          <div class="overflow-auto">
            <table class="f6 w-100 mw8 center" cellspacing="0">
              <thead>
                <tr class="stripe-dark">
                  <th class="fw6 tl pa3 bg-white">Name</th>
                  <th class="fw6 tl pa3 bg-white">Balance</th>
                  <th class="fw6 tl pa3 bg-white"></th>
                </tr>
              </thead>
              <tbody id="addedPeople" class="lh-copy">
              </tbody>
            </table>
          </div>
          <p>Balances last updated: <span id="lastUpdated"></span></p>
        </div>
      </div>
      <div class="mt3"><input id="submit" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="submit" value="Submit"></div>
      <div id="warning" class="mt3 red dn">
        <h4 class="mv0">Email has already been opened - <span class="i">Make sure you send the email!</span></h4>
        <p class="mv0">If you want to update the list then click submit again, otherwise just close this</p>
      </div>
    </form>
  </div>
  <script type='text/javascript'>
    /* global */
    var tempscript = document.createElement("script");
    window.onload = function() {
      // set the date field to today's date by default
      document.getElementById('date').valueAsDate = new Date();

      // fetch the data from google sheets

      tempscript.type = "text/javascript";
      tempscript.id = "tempscript";
      tempscript.src = "https://spreadsheets.google.com/feeds/list/1j9z1tQwSwxclM-ucThVbraR_JaQcvnwnPoDGFLGUFfU/2/public/values?alt=json-in-script&callback=onComplete";
      document.body.appendChild(tempscript);
    };

    var peopleMap = {}; // object of all people, name and balance
    var peopleList = [];
    var attendeeList = []; // list of all attendees
    var peopleField = document.getElementById('people'); // field where person's name is entered
    var dataList = document.getElementById('peopleList'); // list of people to show in drop down
    var addedPeople = document.getElementById('addedPeople'); // table to show added people
    var totalField = document.getElementById('total');

    // callback when google sheet loads
    function onComplete(data) {
      // show the last updated date
      var lastUpdated = new Date(data.feed.updated.$t);
      document.getElementById("lastUpdated").textContent = lastUpdated.toDateString();

      // only keep the row if the name is not empty
      var people = data.feed.entry.filter(p => {
        return p.gsx$firstname.$t.trim() ? true : false;
      });
      // extract the data we want (full name and balance) and discard the rest
      people = people.map(p => {
        var name = p.gsx$firstname.$t.trim() + " " + p.gsx$surname.$t.trim();
        var newP = {
          name,
          balance: p.gsx$balance.$t
        };
        peopleMap[name] = newP;
        return newP;
      });

      // sort the names alphabetically
      people.sort(function compare(a, b) {
        var nameA = a.name.toUpperCase();
        var nameB = b.name.toUpperCase();
        if (nameA < nameB) {
          return -1;
        }
        if (nameA > nameB) {
          return 1;
        }
        return 0;
      });
      var options = ''; // populate list of options
      people.map(p => {
        peopleList.push(p.name);
        options += `<option value="${p.name}">`;
      });
      dataList.innerHTML = options;
      peopleField.placeholder = "type name...";
      tempscript.remove();
    }

    // add the current person to the attendee list
    document.getElementById('addPerson').onclick = addPerson;

    peopleField.oninput = () => {
      var val = peopleField.value;
      if (peopleList.includes(val)) {
        addPerson();
      }
    };

    function addPerson() {
      var name = peopleField.value;
      // if they're not already on the list add them
      if (!attendeeList.includes(name)) {
        // if the person exists in the spreadsheet we show their balance, if not we show "New person"
        var balance = "New person";

        // highlight the people with a negative balance
        var rowClass = "";
        if (peopleMap[name]) {
          balance = peopleMap[name].balance;
          balance = "Â£" + balance;
          if (balance.includes('(')) {
            rowClass = "red";
            balance = "-&pound;" + balance.substring(2, balance.length - 1);
          }

        }
        // add the person to the table
        addedPeople.insertAdjacentHTML("beforeend",
          `<tr class="stripe-dark ${rowClass}">
          <td class="pa3">${name}</td>
          <td class="pa3">${balance}</td>
          <td class="pa3"><input onClick="removePerson(this, '${name}')" class="b ph3 pv2 input-reset ba b--black bg-transparent grow pointer f6" type="button" value="Remove"></td>
        </tr>`);
        attendeeList.push(name);
        totalField.textContent = attendeeList.length;
      }
      // reset the search field
      peopleField.value = "";
      peopleField.focus();
    };

    // remove an attendee
    // element is the button clicked on, name is the name of the person
    function removePerson(element, name) {
      // delete from table
      element.parentElement.parentElement.remove();
      // delete from attendee list
      attendeeList.splice(attendeeList.indexOf(name), 1);
      totalField.textContent = attendeeList.length;
    }

    // on submit prevent page submit and open email app instead
    document.getElementById('form').addEventListener("submit", (e) => {
      // prevent page submit
      e.preventDefault();

      // construct the mail to request
      var email = 'treasurer@stalbansultimate.co.uk';
      var date = document.getElementById('date').value;
      var name = document.getElementById('name').value;
      var comment = document.getElementById('comment').value;
      var subject = `Register for  ${date}`;
      var emailBody =
        `Hi Treasurer,\r\n
Here is the register for ${date}.\r\n
\r\n
Comment: ${comment}\r\n
\r\n
Register;
${attendeeList.join('\r\n')}\r\n
\r\n
Thanks,\r\n
${name}\r\n
`;
      window.location.href = "mailto:" + email + "?subject=" + subject + "&body=" + encodeURIComponent(emailBody);
      // show the warning that email has been opened
      document.getElementById('warning').classList.remove('dn');
    });
  </script>
  <script>
    /* global navigator */
    // add service worker so requests are cached offline and we get add to homescreen functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js').then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(function(err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>

</html>
